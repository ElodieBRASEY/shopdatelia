<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Datelia – Démarrer l’essai (14 jours)</title>
  <style>
    :root { --bg:#fafafa; --card:#fff; --ink:#111; --sub:#666; --muted:#9aa0a6; --line:#eee; --accent:#111; --radius:14px; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto;display:grid;gap:20px;grid-template-columns:1.1fr .9fr}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .pad{padding:22px}
    h1{font-size:22px;margin:0 0 12px}
    h2{font-size:16px;margin:0 0 10px}
    label{display:block;font-size:14px;margin:12px 0 6px}
    input,button,select{font-size:15px}
    input[type="email"],input[type="number"],select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;outline:none}
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
    .hint{font-size:12px;color:var(--sub);margin-top:8px}
    .cta{width:100%;padding:14px;border:0;border-radius:12px;background:var(--accent);color:#fff;cursor:pointer}
    .cta.secondary{background:#2d2d2d}
    .cta[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:12px}
    .row > div{flex:1}
    .summary .line{display:flex;justify-content:space-between;margin:8px 0;font-size:14px}
    .summary .muted{color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--sub)}
    .total-ht{font-size:28px;font-weight:800}
    .ttc-line{font-size:13px;color:var(--sub); margin-top:6px; text-align:right}
    .footnote{font-size:12px;color:var(--sub)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Colonne gauche : formulaire -->
    <div class="card">
      <form id="form" class="pad" action="/api/create-checkout-session-direct" method="get">
        <h1>Démarrer l’essai (14 jours)</h1>

        <label>Email (utilisé pour Stripe)</label>
        <input id="email" name="email" type="email" required placeholder="vous@entreprise.com" />

        <div class="row">
          <div>
            <label>Nombre d’utilisateurs</label>
            <input id="team" name="team_size" type="number" min="1" value="1" required />
          </div>
          <div>
            <label>Pack (obligatoire)</label>
            <select id="pack" name="pack" required>
              <option value="" selected disabled>Choisir un pack…</option>
              <option value="essentiel">Pack Essentiel (inclus)</option>
              <option value="pro">Pack Pro (+30 € / utilisateur)</option>
              <option value="entreprise">Pack Entreprise (+80 € / utilisateur)</option>
            </select>
          </div>
        </div>

        <label>Code promo (optionnel)</label>
        <div class="row">
          <div>
            <input id="promo" name="promo_code" type="text" placeholder="DATELIA25" />
          </div>
          <div style="flex:0 0 180px">
            <button id="applyPromoBtn" type="button" class="cta secondary" style="width:100%">Appliquer</button>
          </div>
        </div>

        <p class="hint">
          Aucun débit aujourd’hui — la carte est enregistrée (SCA incluse si nécessaire).
          Les 14 jours commencent après votre rendez-vous d’onboarding.
        </p>

        <button id="payBtn" class="cta" type="submit">
          Renseigner les informations de paiement (avec CB)
        </button>
        <button id="quoteBtn" type="button" class="cta secondary" style="margin-top:10px;">
          Demander un devis (sans CB)
        </button>
      </form>
    </div>

    <!-- Colonne droite : récap -->
    <div class="card pad">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2>Récapitulatif</h2>
        <span class="badge">0 € aujourd’hui</span>
      </div>

      <div class="summary">
        <div class="line"><span>Utilisateurs (HT)</span><span id="usersLine">—</span></div>
        <div class="line"><span>Pack (HT)</span><span id="packLine">—</span></div>

        <div class="divider"></div>
        <div class="line"><span>Sous-total (avant remise) <b>HT</b></span><span id="subtotalLine">—</span></div>
        <div class="line">
          <span>Remise (HT) <span id="discountTargetLabel" class="muted"></span></span>
          <span id="discountLine">—</span>
        </div>

        <div class="divider"></div>
        <div style="display:flex;justify-content:space-between;align-items:flex-end">
          <div class="footnote">
            Les montants sont affichés en <b>HT</b>.<br />
            Le TTC (TVA 20%) est indiqué à titre informatif.
          </div>
          <div style="text-align:right">
            <div>Total mensuel <b>HT</b></div>
            <div class="total-ht" id="totalHTBig">—</div>
            <div class="ttc-line" id="ttcLine">Estimation TTC (20%) : — / mois</div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="line muted"><span>Aujourd’hui</span><span>0 €</span></div>
        <div class="line"><span>Après 14 jours</span><span id="laterText">— / mois HT</span></div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    // ====== PARAMÈTRES TARIFAIRES (HT) ======
    const PRICE_FIRST_49_PER_USER = 90;  // 1..49
    const PRICE_FROM_50_PER_USER  = 20;  // 50+
    const PACK_SURCHARGE = { essentiel: 0, pro: 30, entreprise: 80 }; // €/utilisateur
    const VAT_RATE = 0.20;

    // >>> Choisis la cible de la remise promo :
    // 'users'  = la remise ne s'applique QUE sur la ligne "Utilisateurs"
    // 'pack'   = la remise ne s'applique QUE sur la ligne "Pack"
    // 'subtotal' = (optionnel) sur le sous-total (comportement d'avant)
    const DISCOUNT_TARGET = 'users';

    // ====== HELPERS / DOM ======
    const money = (n) => new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' }).format(n);

    const $email = document.getElementById('email');
    const $team = document.getElementById('team');
    const $pack = document.getElementById('pack');
    const $promo = document.getElementById('promo');

    const $usersLine = document.getElementById('usersLine');
    const $packLine = document.getElementById('packLine');
    const $subtotalLine = document.getElementById('subtotalLine');
    const $discountTargetLabel = document.getElementById('discountTargetLabel');
    const $discountLine = document.getElementById('discountLine');
    const $totalHTBig = document.getElementById('totalHTBig');
    const $ttcLine = document.getElementById('ttcLine');
    const $laterText = document.getElementById('laterText');

    const $form = document.getElementById('form');
    const $payBtn = document.getElementById('payBtn');
    const $quoteBtn = document.getElementById('quoteBtn');
    const $applyPromoBtn = document.getElementById('applyPromoBtn');

    // État de la promo (pour l’aperçu)
    let currentDiscount = { type: null, value: 0 }; // {type:'percent'|'amount', value:number}

    function clampTeam() {
      const t = Math.max(1, parseInt($team.value || '1', 10));
      $team.value = t;
      return t;
    }

    function usersCostHT(team) {
      const first = Math.min(team, 49);
      const rest  = Math.max(team - 49, 0);
      const cost  = first * PRICE_FIRST_49_PER_USER + rest * PRICE_FROM_50_PER_USER;
      const txt   = rest > 0
        ? `${first} × ${money(PRICE_FIRST_49_PER_USER)} + ${rest} × ${money(PRICE_FROM_50_PER_USER)} = ${money(cost)}`
        : `${first} × ${money(PRICE_FIRST_49_PER_USER)} = ${money(cost)}`;
      return { cost, txt };
    }

    function packCostHT(team, packKey) {
      const add = PACK_SURCHARGE[packKey] ?? 0;
      return { cost: team * add, txt: `${team} × ${money(add)} = ${money(team * add)}` };
    }

    function updateSummary() {
      const team = clampTeam();
      const packKey = $pack.value || null;

      // Coûts HT
      const { cost: usersCost, txt: usersTxt } = usersCostHT(team);
      const { cost: packCost,  txt: packTxt  } = packKey ? packCostHT(team, packKey) : { cost:0, txt:'—' };

      const subtotalHT = usersCost + packCost;

      // Base de remise sur un seul poste
      let baseForDiscount = 0;
      let targetLabel = '';
      if (currentDiscount.type) {
        if (DISCOUNT_TARGET === 'users') { baseForDiscount = usersCost; targetLabel = '(sur utilisateurs)'; }
        else if (DISCOUNT_TARGET === 'pack') { baseForDiscount = packCost; targetLabel = '(sur pack)'; }
        else { baseForDiscount = subtotalHT; targetLabel = '(sur sous-total)'; } // fallback
      }

      // Calcul de la remise
      let discountHT = 0;
      if (currentDiscount.type === 'percent') {
        discountHT = baseForDiscount * (currentDiscount.value / 100);
      } else if (currentDiscount.type === 'amount') {
        discountHT = Math.min(baseForDiscount, currentDiscount.value); // pas de report sur l’autre ligne
      }

      const totalHT  = Math.max(0, subtotalHT - discountHT);
      const totalTTC = totalHT * (1 + VAT_RATE);

      // Affichages
      $usersLine.textContent = usersTxt;
      $packLine.textContent  = packTxt;
      $subtotalLine.textContent = money(subtotalHT);
      $discountTargetLabel.textContent = targetLabel;
      $discountLine.textContent = discountHT > 0 ? '− ' + money(discountHT) : '—';
      $totalHTBig.textContent = money(totalHT);
      $ttcLine.textContent = `Estimation TTC (20%) : ${money(totalTTC)} / mois`;
      $laterText.textContent = `${money(totalHT)} / mois HT`;
    }

    async function refreshPromo() {
      const code = ($promo.value || '').trim();
      currentDiscount = { type: null, value: 0 };
      if (!code) { updateSummary(); return; }

      try {
        const r = await fetch(`/api/promo-lookup?code=${encodeURIComponent(code)}`);
        const data = await r.json().catch(() => ({}));
        if (r.ok && data.ok && data.found && data.coupon) {
          if (data.coupon.percent_off != null) currentDiscount = { type:'percent', value:data.coupon.percent_off };
          else if (data.coupon.amount_off != null) currentDiscount = { type:'amount', value:(data.coupon.amount_off/100) };
        } else {
          currentDiscount = { type:null, value:0 };
        }
      } catch {
        currentDiscount = { type:null, value:0 };
      }
      updateSummary();
    }

    // Listeners UI
    ['input','change'].forEach(evt => {
      $team.addEventListener(evt, updateSummary);
      $pack.addEventListener(evt, updateSummary);
    });
    $applyPromoBtn.addEventListener('click', refreshPromo);

    updateSummary();

    // Formulaire CB (setup)
    $form.addEventListener('submit', (e) => {
      const team = clampTeam();
      if (!$email.value || !/.+@.+\..+/.test($email.value)) { e.preventDefault(); alert('Merci d’indiquer un email valide.'); $email.focus(); return; }
      if (!$pack.value) { e.preventDefault(); alert('Merci de sélectionner un pack.'); $pack.focus(); return; }
      if (team < 1) { e.preventDefault(); alert('Au moins 1 utilisateur.'); $team.focus(); return; }
      $payBtn.disabled = true;
      $payBtn.textContent = 'Ouverture de Stripe…';
    });

    // Devis (sans CB)
    $quoteBtn.addEventListener('click', async () => {
      const email = $email.value;
      const team = clampTeam();
      const pack = $pack.value;
      const promo = ($promo.value || '').trim();

      if (!/.+@.+\..+/.test(email)) { alert('Email invalide'); return; }
      if (!pack) { alert('Merci de sélectionner un pack'); return; }

      const oldLabel = $quoteBtn.textContent;
      $quoteBtn.disabled = true;
      $quoteBtn.textContent = 'Création du devis…';

      try {
        const resp = await fetch('/api/create-quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, team_size: team, pack, promo_code: promo || undefined })
        });
        const data = await resp.json().catch(() => ({}));

        if (resp.ok && (data.ok || data.url || data.id)) {
          if (data.url) window.open(data.url, '_blank');       // page publique si dispo
          if (data.dashboardUrl) window.open(data.dashboardUrl, '_blank'); // page Dashboard devis
          window.location.href = 'https://www.datelia.ai/merci';
          return;
        }
        alert('Impossible de créer le devis : ' + (data.error || `HTTP ${resp.status}`));
      } catch (err) {
        alert('Impossible de créer le devis : ' + err.message);
      } finally {
        $quoteBtn.disabled = false;
        $quoteBtn.textContent = oldLabel;
      }
    });
  })();
  </script>
</body>
</html>
